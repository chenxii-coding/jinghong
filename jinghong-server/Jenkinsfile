pipeline {
    agent any
    environment {
        IMAGE_NAME = "jinghong-server"
        IMAGE_VERSION = "v1.1.0"
        CONTAINER_PORT = 8000
        CONTAINER_NAME = "jinghong-server"
        DOCKER_HUB_PAIR = credentials("docker-hub-pair")
        DOCKER_TAG_PREFIX = "chenxii81"
    }
    stages {
        stage('æ‹‰å–ä»£ç ') {
            steps {
                echo 'ğŸ¦Š ä»gitä»“åº“æ‹‰å–ä»£ç '
                git branch: 'main', url: 'https://github.com/chenxii-coding/jinghong.git'
            }
        }
        stage('æ‰“åŒ…é•œåƒ') {
            steps {
                sh 'docker build -t ${IMAGE_NAME}:${IMAGE_VERSION} ./${IMAGE_NAME}'
                echo 'ğŸ¥³ æˆåŠŸç”Ÿæˆé•œåƒï¼'
            }
        }
        stage('æ¨é€é•œåƒ') {
            steps {
                sh 'docker login -u ${DOCKER_HUB_PAIR_USR} -p ${DOCKER_HUB_PAIR_PSW}'
                sh 'docker tag ${IMAGE_NAME}:${IMAGE_VERSION} ${DOCKER_TAG_PREFIX}/${IMAGE_NAME}:${IMAGE_VERSION}'
                sh 'docker push ${DOCKER_TAG_PREFIX}/${IMAGE_NAME}:${IMAGE_VERSION}'
                echo 'ğŸ¥³ æˆåŠŸæ¨é€é•œåƒ'
            }
        }
        stage('å¯åŠ¨å®¹å™¨') {
            steps {
                script {
                    def code = sh(
                            script: "docker ps -a | grep ${CONTAINER_NAME}",
                            returnStatus: true
                    )
                    if (code == 0) {
                        echo "âš ï¸ æ‰¾åˆ° ${CONTAINER_NAME} ç›¸å…³å®¹å™¨, æ­£åœ¨åˆ é™¤"
                        sh("docker ps -a | grep ${CONTAINER_NAME} | awk '{print \$1}' | xargs docker rm -f")
                    } else {
                        echo "æ²¡æœ‰æ‰¾åˆ° ${CONTAINER_NAME} ç›¸å…³å®¹å™¨"
                    }
                    def code1 = sh(
                            script: "docker image ls | grep ${IMAGE_NAME}",
                            returnStatus: true
                    )
                    if (code1 == 0) {
                        echo "âš ï¸ æ‰¾åˆ° ${IMAGE_NAME} ç›¸å…³é•œåƒ, æ­£åœ¨åˆ é™¤"
                        sh("docker image ls | grep ${IMAGE_NAME} | awk '{print \$3}' | xargs docker rmi -f")
                    } else {
                        echo "æ²¡æœ‰æ‰¾åˆ° ${IMAGE_NAME} ç›¸å…³é•œåƒ"
                    }
                }
                echo 'ğŸš— ğŸŒ¬ å†å²é•œåƒå¤„ç†å®Œæ¯•'
                echo 'ğŸ’¦ æ­£åœ¨æ‹‰å–é•œåƒ..'
                sh 'docker pull ${DOCKER_TAG_PREFIX}/${IMAGE_NAME}:${IMAGE_VERSION}'
                sh("docker run -dp ${CONTAINER_PORT}:${CONTAINER_PORT} --name ${CONTAINER_NAME} ${DOCKER_TAG_PREFIX}/${IMAGE_NAME}:${IMAGE_VERSION}")
                echo 'ğŸ‰ éƒ¨ç½²æˆåŠŸï¼'
            }
        }
    }
    post {
        always {
            echo 'æµæ°´çº¿æ‰§è¡Œå®Œæˆï¼Œå·²é€€å‡º'
        }
    }
}
